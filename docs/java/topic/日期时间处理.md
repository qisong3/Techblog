---
title: 日期时间处理
description:  时间处理
date: 2020-09-04
last-update: 2020-09-04
tags:
 - Java
keywords:
 - Java
 - 时间处理
---

## 概述
自JDK1.0起，时间处理相关API就已经发布。不过由于设计不合理，并且没有考虑到并发，时区等，一直为人所诟病。

JDK1.1中新增了时区处理，但并发的问题继续保留了下来。为了避坑，三方库如JODA-Time给出了自己的解决方案。

核心代码被弃用，三方库风生水起，这样显然让Java社区很没有面子，JDK1.8推出了全新的日期/时间处理API，算是给出了交代。

## 早期的Java时间处理

### Date
Date类表示一个特定的时间点，精确到毫秒。Date类中的核心变量是一个格里尼治时间1970.1.1零点至今的时间戳。用这么一个变量，既要表示日期，又要表示时间，还要考虑时区，确实是有些困难。

Date类的构造函数需要传入一个长整型的时间戳，或者默认使用系统当前时间的时间戳。

```java 
    // constrctor 1 
    public Date(long date) {
        fastTime = date;
    }

    // constrctor 2
    public Date() {
        this(System.currentTimeMillis());
    }

    // consturctor 3
    public Date(int year, int month, int date, int hrs, int min) {
        this(year, month, date, hrs, min, 0);
    }
```
前两个构造函数比较常用，最后一个构造函数，就有一些坑了。虽说时间戳是从1970年开始算的，但是这里的年份确是从1900年开始算的，月份也是从0开始而不是从1开始，很不合理，JDK1.1就被弃用了。

与此同时，从Date中获取Year,Month,Day等也都被弃用了，官方API中寿命这么短暂的，也确实不多。

Date类的其他函数，目前还没有被弃用的已经不多了，简而言之，Date类存在的最大价值，是用一个长整型定义了1970年以来的各个时间。

### SimpleDateFormat

计算机的程序终究还是要展示给用户看的，只有一个长整型时间戳显然是很难理解的。为了将日期时间在机器语言和人类语言之间做转换，需要用到SimpleDateFormat。

SimpleDateFormat用于格式化(format 机器语言->人类语言)和解析（parse 人类语言->机器语言）日期和时间。

以一个简单的例子说明，通过构造模板来输出当前的时间。

```java
    // 构造对象   
    String pattern = "E M yyyy HH:mm:ss.SSS Z";
    // 格式化输出
    System.out.println(new SimpleDateFormat(pattern).format(new Date())); 
```
输出
```
公元 星期五 10 2020 17:50:31.189 +0800
```


#### 模板语法
翻译需要翻译的模板，模板可以通过构造函数来创建。模板有对应的语法格式，列举如下。

|字符|解释|
|:--:|:--|
|G|Era designator (before christ, after christ)|
|y|Year (e.g. 12 or 2012). Use either yy or yyyy.|
|M|Month in year. Number of M's determine length of format (e.g. MM, MMM or MMMMM)|
|d|Day in month. Number of d's determine length of format (e.g. d or dd)|
|h|Hour of day, 1-12 (AM / PM) (normally hh)|
|H|Hour of day, 0-23 (normally HH)|
|s|Second in minute, 0-59 (normally ss)|
|S|Millisecond in second, 0-999 (normally SSS)|
|E|Day in week (e.g Monday, Tuesday etc.)|
|F|Day of week in month (e.g. 1st Thursday of December)|
|w|Week in year (1-53)|
|W|Week in month (0-5)|
|a|AM / PM marker|
|k|Hour in day (1-24, unlike HH's 0-23)|
|K|Hour in day, AM / PM (0-11)|
|z|Time Zone|
    	
用来翻译日期时间的模板，就是由对应的字符组合起来表示。

|模式|举例|
|:--:|:--:|
|dd-MM-yy |31-01-12|
|MM-dd-yyyy |01-31-2012|
|dd-MM-yyyy |31-01-2012|
|yyyy-MM-dd |2012-01-31|
|yyyy-MM-dd HH:mm:ss |2012-01-31 23:59:59|
|yyyy-MM-dd HH:mm:ss.SSS |2012-01-31 23:59:59.999|
|EEEEE MMMMM yyyy HH:mm:ss.SSSZ |Saturday November 2012 10:45:42.720+0100|

举例说明，一个Date对象可以格式化成需要的输出形式。
```java
    // 由Date对象获得格式化日期
    // 模板对象   
    String pattern = "E M yyyy HH:mm:ss.SSS Z";
    // 格式化输出
    System.out.println(new SimpleDateFormat(pattern).format(new Date()));
    // 输出内容
    // 公元 星期一 10 2020 14:59:06.410 +0800 
```

反之同理，从一个格式化输出的时间，可以获得具体的Date对象。
```java
    // 由Date对象获得格式化日期
    // 摸板对象   
    String pattern = "yyyy-MM-dd HH:mm:ss";
    // 日期字符串
    String dateStr = "2020-10-19 15:23:33";
    // 格式化输出
    System.out.println(new SimpleDateFormat(pattern).parse(dateStr).getTime());
    // 输出内容
    // 1603092213000
```

#### 本地定制化
各个国家对月份的或者星期的称呼可能不同，如果都按Monday，March等输出，并不能满足区域本地化的要求。

DateFormatSymbols便是辅助实现的类。可以通过DateFormatSymbols设置星期，月份，上下午，时区等定制化内容。

```java 
    
    private static void local() throws ParseException{
        Locale locale = new Locale("zh", "CHINA");
        DateFormatSymbols dateFormatSymbols = new DateFormatSymbols(locale);
        dateFormatSymbols.setWeekdays(new String[]{
                "星期一",
                "星期二",
                "星期三",
                "星期四",
                "星期五",
                "星期六",
                "星期日"
        });

        String pattern = "EEEEE MMMMM yyyy";
        SimpleDateFormat simpleDateFormat =
                new SimpleDateFormat(pattern, dateFormatSymbols);
        System.out.println(simpleDateFormat.format(new Date()));
    }
    
    // 输出
    // 星期三 十月 2020
```

#### 时区
JDK1推出的日期时间处理，没有考虑到时区问题。不同国家和地区使用同一个时间计时，这必然会造成混乱。JDK1.1发布了TimeZone，可以用之代表不同的时区，解决了这个问题。

TimeZone代表相对于GMT时间的偏移，精确到分钟，使用字符串"GMT+:08:00"或者"Asia/Shanghai"可代表东八时区。

```java 
    
    private static void timezone(){
            
        // 时区类型
        Arrays.stream(TimeZone.getAvailableIDs()).forEach(item -> System.out.print(item + " "));
        System.out.println();

        // 按时区输出
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ssZ");
        simpleDateFormat.setTimeZone(TimeZone.getTimeZone("Europe/London"));
        System.out.println(simpleDateFormat.format(new Date()));

        simpleDateFormat.setTimeZone(TimeZone.getTimeZone("Asia/Shanghai"));
        System.out.println(simpleDateFormat.format(new Date()));
           
    }
```
输出
```
Africa/Abidjan Africa/Accra Africa/Addis_Ababa Africa/Algiers Africa/Asmara Africa/Asmera Africa/Bamako Africa/Bangui Africa/Banjul Africa/Bissau Africa/Blantyre Africa/Brazzaville Africa/Bujumbura Africa/Cairo Africa/Casablanca Africa/Ceuta Africa/Conakry Africa/Dakar Africa/Dar_es_Salaam Africa/Djibouti Africa/Douala Africa/El_Aaiun Africa/Freetown Africa/Gaborone Africa/Harare Africa/Johannesburg Africa/Juba Africa/Kampala Africa/Khartoum Africa/Kigali Africa/Kinshasa Africa/Lagos Africa/Libreville Africa/Lome Africa/Luanda Africa/Lubumbashi Africa/Lusaka Africa/Malabo Africa/Maputo Africa/Maseru Africa/Mbabane Africa/Mogadishu Africa/Monrovia Africa/Nairobi Africa/Ndjamena Africa/Niamey Africa/Nouakchott Africa/Ouagadougou Africa/Porto-Novo Africa/Sao_Tome Africa/Timbuktu Africa/Tripoli Africa/Tunis Africa/Windhoek America/Adak America/Anchorage America/Anguilla America/Antigua America/Araguaina America/Argentina/Buenos_Aires America/Argentina/Catamarca America/Argentina/ComodRivadavia America/Argentina/Cordoba America/Argentina/Jujuy America/Argentina/La_Rioja America/Argentina/Mendoza America/Argentina/Rio_Gallegos America/Argentina/Salta America/Argentina/San_Juan America/Argentina/San_Luis America/Argentina/Tucuman America/Argentina/Ushuaia America/Aruba America/Asuncion America/Atikokan America/Atka America/Bahia America/Bahia_Banderas America/Barbados America/Belem America/Belize America/Blanc-Sablon America/Boa_Vista America/Bogota America/Boise America/Buenos_Aires America/Cambridge_Bay America/Campo_Grande America/Cancun America/Caracas America/Catamarca America/Cayenne America/Cayman America/Chicago America/Chihuahua America/Coral_Harbour America/Cordoba America/Costa_Rica America/Creston America/Cuiaba America/Curacao America/Danmarkshavn America/Dawson America/Dawson_Creek America/Denver America/Detroit America/Dominica America/Edmonton America/Eirunepe America/El_Salvador America/Ensenada America/Fort_Nelson America/Fort_Wayne America/Fortaleza America/Glace_Bay America/Godthab America/Goose_Bay America/Grand_Turk America/Grenada America/Guadeloupe America/Guatemala America/Guayaquil America/Guyana America/Halifax America/Havana America/Hermosillo America/Indiana/Indianapolis America/Indiana/Knox America/Indiana/Marengo America/Indiana/Petersburg America/Indiana/Tell_City America/Indiana/Vevay America/Indiana/Vincennes America/Indiana/Winamac America/Indianapolis America/Inuvik America/Iqaluit America/Jamaica America/Jujuy America/Juneau America/Kentucky/Louisville America/Kentucky/Monticello America/Knox_IN America/Kralendijk America/La_Paz America/Lima America/Los_Angeles America/Louisville America/Lower_Princes America/Maceio America/Managua America/Manaus America/Marigot America/Martinique America/Matamoros America/Mazatlan America/Mendoza America/Menominee America/Merida America/Metlakatla America/Mexico_City America/Miquelon America/Moncton America/Monterrey America/Montevideo America/Montreal America/Montserrat America/Nassau America/New_York America/Nipigon America/Nome America/Noronha America/North_Dakota/Beulah America/North_Dakota/Center America/North_Dakota/New_Salem America/Ojinaga America/Panama America/Pangnirtung America/Paramaribo America/Phoenix America/Port-au-Prince America/Port_of_Spain America/Porto_Acre America/Porto_Velho America/Puerto_Rico America/Punta_Arenas America/Rainy_River America/Rankin_Inlet America/Recife America/Regina America/Resolute America/Rio_Branco America/Rosario America/Santa_Isabel America/Santarem America/Santiago America/Santo_Domingo America/Sao_Paulo America/Scoresbysund America/Shiprock America/Sitka America/St_Barthelemy America/St_Johns America/St_Kitts America/St_Lucia America/St_Thomas America/St_Vincent America/Swift_Current America/Tegucigalpa America/Thule America/Thunder_Bay America/Tijuana America/Toronto America/Tortola America/Vancouver America/Virgin America/Whitehorse America/Winnipeg America/Yakutat America/Yellowknife Antarctica/Casey Antarctica/Davis Antarctica/DumontDUrville Antarctica/Macquarie Antarctica/Mawson Antarctica/McMurdo Antarctica/Palmer Antarctica/Rothera Antarctica/South_Pole Antarctica/Syowa Antarctica/Troll Antarctica/Vostok Arctic/Longyearbyen Asia/Aden Asia/Almaty Asia/Amman Asia/Anadyr Asia/Aqtau Asia/Aqtobe Asia/Ashgabat Asia/Ashkhabad Asia/Atyrau Asia/Baghdad Asia/Bahrain Asia/Baku Asia/Bangkok Asia/Barnaul Asia/Beirut Asia/Bishkek Asia/Brunei Asia/Calcutta Asia/Chita Asia/Choibalsan Asia/Chongqing Asia/Chungking Asia/Colombo Asia/Dacca Asia/Damascus Asia/Dhaka Asia/Dili Asia/Dubai Asia/Dushanbe Asia/Famagusta Asia/Gaza Asia/Harbin Asia/Hebron Asia/Ho_Chi_Minh Asia/Hong_Kong Asia/Hovd Asia/Irkutsk Asia/Istanbul Asia/Jakarta Asia/Jayapura Asia/Jerusalem Asia/Kabul Asia/Kamchatka Asia/Karachi Asia/Kashgar Asia/Kathmandu Asia/Katmandu Asia/Khandyga Asia/Kolkata Asia/Krasnoyarsk Asia/Kuala_Lumpur Asia/Kuching Asia/Kuwait Asia/Macao Asia/Macau Asia/Magadan Asia/Makassar Asia/Manila Asia/Muscat Asia/Nicosia Asia/Novokuznetsk Asia/Novosibirsk Asia/Omsk Asia/Oral Asia/Phnom_Penh Asia/Pontianak Asia/Pyongyang Asia/Qatar Asia/Qyzylorda Asia/Rangoon Asia/Riyadh Asia/Saigon Asia/Sakhalin Asia/Samarkand Asia/Seoul Asia/Shanghai Asia/Singapore Asia/Srednekolymsk Asia/Taipei Asia/Tashkent Asia/Tbilisi Asia/Tehran Asia/Tel_Aviv Asia/Thimbu Asia/Thimphu Asia/Tokyo Asia/Tomsk Asia/Ujung_Pandang Asia/Ulaanbaatar Asia/Ulan_Bator Asia/Urumqi Asia/Ust-Nera Asia/Vientiane Asia/Vladivostok Asia/Yakutsk Asia/Yangon Asia/Yekaterinburg Asia/Yerevan Atlantic/Azores Atlantic/Bermuda Atlantic/Canary Atlantic/Cape_Verde Atlantic/Faeroe Atlantic/Faroe Atlantic/Jan_Mayen Atlantic/Madeira Atlantic/Reykjavik Atlantic/South_Georgia Atlantic/St_Helena Atlantic/Stanley Australia/ACT Australia/Adelaide Australia/Brisbane Australia/Broken_Hill Australia/Canberra Australia/Currie Australia/Darwin Australia/Eucla Australia/Hobart Australia/LHI Australia/Lindeman Australia/Lord_Howe Australia/Melbourne Australia/NSW Australia/North Australia/Perth Australia/Queensland Australia/South Australia/Sydney Australia/Tasmania Australia/Victoria Australia/West Australia/Yancowinna Brazil/Acre Brazil/DeNoronha Brazil/East Brazil/West CET CST6CDT Canada/Atlantic Canada/Central Canada/Eastern Canada/Mountain Canada/Newfoundland Canada/Pacific Canada/Saskatchewan Canada/Yukon Chile/Continental Chile/EasterIsland Cuba EET EST5EDT Egypt Eire Etc/GMT Etc/GMT+0 Etc/GMT+1 Etc/GMT+10 Etc/GMT+11 Etc/GMT+12 Etc/GMT+2 Etc/GMT+3 Etc/GMT+4 Etc/GMT+5 Etc/GMT+6 Etc/GMT+7 Etc/GMT+8 Etc/GMT+9 Etc/GMT-0 Etc/GMT-1 Etc/GMT-10 Etc/GMT-11 Etc/GMT-12 Etc/GMT-13 Etc/GMT-14 Etc/GMT-2 Etc/GMT-3 Etc/GMT-4 Etc/GMT-5 Etc/GMT-6 Etc/GMT-7 Etc/GMT-8 Etc/GMT-9 Etc/GMT0 Etc/Greenwich Etc/UCT Etc/UTC Etc/Universal Etc/Zulu Europe/Amsterdam Europe/Andorra Europe/Astrakhan Europe/Athens Europe/Belfast Europe/Belgrade Europe/Berlin Europe/Bratislava Europe/Brussels Europe/Bucharest Europe/Budapest Europe/Busingen Europe/Chisinau Europe/Copenhagen Europe/Dublin Europe/Gibraltar Europe/Guernsey Europe/Helsinki Europe/Isle_of_Man Europe/Istanbul Europe/Jersey Europe/Kaliningrad Europe/Kiev Europe/Kirov Europe/Lisbon Europe/Ljubljana Europe/London Europe/Luxembourg Europe/Madrid Europe/Malta Europe/Mariehamn Europe/Minsk Europe/Monaco Europe/Moscow Europe/Nicosia Europe/Oslo Europe/Paris Europe/Podgorica Europe/Prague Europe/Riga Europe/Rome Europe/Samara Europe/San_Marino Europe/Sarajevo Europe/Saratov Europe/Simferopol Europe/Skopje Europe/Sofia Europe/Stockholm Europe/Tallinn Europe/Tirane Europe/Tiraspol Europe/Ulyanovsk Europe/Uzhgorod Europe/Vaduz Europe/Vatican Europe/Vienna Europe/Vilnius Europe/Volgograd Europe/Warsaw Europe/Zagreb Europe/Zaporozhye Europe/Zurich GB GB-Eire GMT GMT0 Greenwich Hongkong Iceland Indian/Antananarivo Indian/Chagos Indian/Christmas Indian/Cocos Indian/Comoro Indian/Kerguelen Indian/Mahe Indian/Maldives Indian/Mauritius Indian/Mayotte Indian/Reunion Iran Israel Jamaica Japan Kwajalein Libya MET MST7MDT Mexico/BajaNorte Mexico/BajaSur Mexico/General NZ NZ-CHAT Navajo PRC PST8PDT Pacific/Apia Pacific/Auckland Pacific/Bougainville Pacific/Chatham Pacific/Chuuk Pacific/Easter Pacific/Efate Pacific/Enderbury Pacific/Fakaofo Pacific/Fiji Pacific/Funafuti Pacific/Galapagos Pacific/Gambier Pacific/Guadalcanal Pacific/Guam Pacific/Honolulu Pacific/Johnston Pacific/Kiritimati Pacific/Kosrae Pacific/Kwajalein Pacific/Majuro Pacific/Marquesas Pacific/Midway Pacific/Nauru Pacific/Niue Pacific/Norfolk Pacific/Noumea Pacific/Pago_Pago Pacific/Palau Pacific/Pitcairn Pacific/Pohnpei Pacific/Ponape Pacific/Port_Moresby Pacific/Rarotonga Pacific/Saipan Pacific/Samoa Pacific/Tahiti Pacific/Tarawa Pacific/Tongatapu Pacific/Truk Pacific/Wake Pacific/Wallis Pacific/Yap Poland Portugal ROK Singapore SystemV/AST4 SystemV/AST4ADT SystemV/CST6 SystemV/CST6CDT SystemV/EST5 SystemV/EST5EDT SystemV/HST10 SystemV/MST7 SystemV/MST7MDT SystemV/PST8 SystemV/PST8PDT SystemV/YST9 SystemV/YST9YDT Turkey UCT US/Alaska US/Aleutian US/Arizona US/Central US/East-Indiana US/Eastern US/Hawaii US/Indiana-Starke US/Michigan US/Mountain US/Pacific US/Pacific-New US/Samoa UTC Universal W-SU WET Zulu EST HST MST ACT AET AGT ART AST BET BST CAT CNT CST CTT EAT ECT IET IST JST MIT NET NST PLT PNT PRT PST SST VST 
2020-10-19 10:18:28+0100
2020-10-19 17:18:28+0800
```

#### 使用中需要注意的

早期的时间处理，最为人诟病的便是在多线程环境下的表现。单独的Date对象是安全的，但是一旦涉及到格式化或者翻译，就要使用到SimpleDateFormat，就可能引起多线程异常。

举一个多线程下使用同一个SimpleDateFormat的例子。

```java 
    
    private static  SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    private static void createException() {
        for (int i = 0; i < 100; i++){
            UnsafeTimeThread timeThread = new UnsafeTimeThread();
            timeThread.start();
        }
    }

    private static class  UnsafeTimeThread extends Thread{
        @SneakyThrows
        @Override
        public void run(){
            String string = dateFormat.format(new Date());
            System.out.println(dateFormat.parse(string));
        }
    }
```
基本会出现类似的运行结果
``` 
    at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514)
        at java.text.DateFormat.parse(DateFormat.java:364)
        at cn.errison.time.OldTimeDemo$UnsafeTimeThread.run(OldTimeDemo.java:85)
    Exception in thread "Thread-64" java.lang.NumberFormatException: multiple points
        at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890)
        at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110)
        at java.lang.Double.parseDouble(Double.java:538)
        at java.text.DigitList.getDouble(DigitList.java:169)
        at java.text.DecimalFormat.parse(DecimalFormat.java:2089)
        at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869)
        at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514)
        at java.text.DateFormat.parse(DateFormat.java:364)
        at cn.errison.time.OldTimeDemo$UnsafeTimeThread.run(OldTimeDemo.java:85)
```
产生故障的原因是，SimpleDateFormat不是线程安全的，有类共有变量，这样多线程访问时产生竞态，很有可能会导致异常。

## Java8 以后

## 其他时间处理工具
